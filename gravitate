#!/usr/bin/env node

var request = require('request'),
    unzip = require('unzip'),
    path = require('path'),
    AdmZip = require('adm-zip'),
    mv = require('mv'),
    slug = require('slug'),
    fs = require('fs-extra');

var data = {
  name: 'grav-project',
  slug: 'grav-project',
  repo: 'https://github.com/Polarbitco/gravitate-grav/archive/master.zip',
  temp: './temp.zip',
  version: '1.0'
}

var extractPath =  path.join(path.dirname(fs.realpathSync(__filename)), './');
bootstrap();

function bootstrap() {
  var args = process.argv.slice(2);

  switch (args[0]) {
    case 'new':
      console.log('Creating your new Grav project: ' + args[1]);
      data.name = args[1];
      data.slug = slug(data.name);
      download();
    break;
    case 'help':
      help();
    break;
    default:
      help();
   }
}

function help() {
  console.log('Usage:');
  console.log('  gravitate new SITE_NAME')
}

function download() {
  console.log('Downloading Grav...');
  request(data.repo)
    .pipe(fs.createWriteStream(data.temp))
    .on('close', function () {
      extract();
    });
}

function extract() {
  console.log('Extracting zip...')
  var zip = new AdmZip(data.temp);
  zip.extractAllTo(extractPath + 'temp', true);
  fs.unlinkSync(data.temp);
  moveDir();
}

function moveDir() {
  console.log('Moving directory...')
  fs.readdir(extractPath + 'temp', (err, files) => {
    copyDir(files[0]);
  })
}

function copyDir(file) {
  console.log('Copying contents...')
  var dirPath = extractPath + 'temp/' + file;
  mv(dirPath, extractPath + data.slug, {mkdirp: true}, function(err) {
    fs.removeSync(extractPath + 'temp/');
  });
  template();
}

function template() {
  console.log('Write custom template...');
}
